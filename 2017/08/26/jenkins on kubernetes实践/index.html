<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="jenkins是什么？Jenkins是一个开源的持续集成工具，可用于自动化的执行与构建，测试和交付或部署软件有关的各种任务,有非常丰富的插件支持。kubernetes是什么？Kubernetes是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。这个视频生动地介绍了k8sjenkins on k8s 有什么好处？jenkins通过单Master多个Slave">
<meta name="keywords" content="jenkins,docker,kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="jenkins on kubernetes实践">
<meta property="og:url" content="http://www.throwsnew.com/2017/08/26/jenkins on kubernetes实践/index.html">
<meta property="og:site_name" content="throwsnew">
<meta property="og:description" content="jenkins是什么？Jenkins是一个开源的持续集成工具，可用于自动化的执行与构建，测试和交付或部署软件有关的各种任务,有非常丰富的插件支持。kubernetes是什么？Kubernetes是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。这个视频生动地介绍了k8sjenkins on k8s 有什么好处？jenkins通过单Master多个Slave">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/jenkins-arch.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/kongzhimianban.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/pvlife.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/success.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/config1.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/config.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/container.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/pods1.png">
<meta property="og:image" content="http://www.throwsnew.com/images/jenkins/result2.png">
<meta property="og:updated_time" content="2019-05-04T15:44:19.590Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jenkins on kubernetes实践">
<meta name="twitter:description" content="jenkins是什么？Jenkins是一个开源的持续集成工具，可用于自动化的执行与构建，测试和交付或部署软件有关的各种任务,有非常丰富的插件支持。kubernetes是什么？Kubernetes是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。这个视频生动地介绍了k8sjenkins on k8s 有什么好处？jenkins通过单Master多个Slave">
<meta name="twitter:image" content="http://www.throwsnew.com/images/jenkins/jenkins-arch.png">






  <link rel="canonical" href="http://www.throwsnew.com/2017/08/26/jenkins on kubernetes实践/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>jenkins on kubernetes实践 | throwsnew</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1707f79414590fdb8341512803ca4504";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">throwsnew</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>专题</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.throwsnew.com/2017/08/26/jenkins on kubernetes实践/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xianfeng Song">
      <meta itemprop="description" content="a blog learn share practice">
      <meta itemprop="image" content="/images/logoNew.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="throwsnew">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">jenkins on kubernetes实践
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-26 21:05:46" itemprop="dateCreated datePublished" datetime="2017-08-26T21:05:46+08:00">2017-08-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-04 23:44:19" itemprop="dateModified" datetime="2019-05-04T23:44:19+08:00">2019-05-04</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/容器技术/" itemprop="url" rel="index"><span itemprop="name">容器技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>jenkins是什么？</strong><br>Jenkins是一个开源的持续集成工具，可用于自动化的执行与构建，测试和交付或部署软件有关的各种任务,有非常丰富的插件支持。<br><strong>kubernetes是什么？</strong><br>Kubernetes是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。<a href="http://docs.kubernetes.org.cn/227.html" target="_blank" rel="noopener">这个视频生动地介绍了k8s</a><br><strong>jenkins on k8s 有什么好处？</strong><br>jenkins通过单Master多个Slave的方式提供服务，Master保存了任务的配置信息，安装的插件等等，而slave主要负责执行任务，在使用中存在以下几个问题：<br><a id="more"></a></p>
<ol>
<li>当存在多个slave时，运行slave的机器难以统一管理，每次添加新节点时总要做大量的重复工作。</li>
<li>由于不同业务的构建频率并不相同，在使用会发现有很多slave大多数时间都处于空闲状态，造成资源浪费</li>
<li>jenkins默认采取保守的调度方式，造成某些slave的负载过高，任务不能平均分配<br><img src="/images/jenkins/jenkins-arch.png" alt="jenkins架构"></li>
</ol>
<p>使用k8s管理jenkins具有以下优势：</p>
<ol>
<li>使用docker运行jenkins保证环境的一致性，可以根据不同业务选择合适的镜像</li>
<li>k8s对抽象后的资源（pods）进行统一的管理调度，提供资源隔离和共享，使机器计算资源变得弹性可扩展,避免资源浪费。</li>
<li>k8s提供容器的自愈功能，能够保证始终有一定数量的容器是可用的</li>
<li>k8s默认的调度器提供了针对节点当前资源分配容器的调度策略，调度器支持插件化部署便于自定义。</li>
</ol>
<h3 id="一，搭建环境"><a href="#一，搭建环境" class="headerlink" title="一，搭建环境"></a><strong>一，搭建环境</strong></h3><h4 id="工具准备"><a href="#工具准备" class="headerlink" title="工具准备"></a>工具准备</h4><blockquote>
<p>kubernetes v1.8.4<br>docker v1.12.6<br>jenkins master镜像 jenkins/jenkins:lts（v2.73.3）<br>slave镜像 jenkinsci/jnlp-slave<br>Kubernetes plugin (v1.1)</p>
</blockquote>
<h4 id="安装kubernetes集群"><a href="#安装kubernetes集群" class="headerlink" title="安装kubernetes集群"></a>安装kubernetes集群</h4><p>中文教程：<a href="https://www.kubernetes.org.cn/2906.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/2906.html</a><br>安装成功之后访问dashboard地址就可以看到集群的控制面板：<br><img src="/images/jenkins/kongzhimianban.png" alt="dashboard"><br>集群安装完成后，创建命名空间kubernetes-plugin<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace kubernetes-plugin</span><br><span class="line">kubectl config set-context $(kubectl config current-context) --namespace=kubernetes-plugin</span><br><span class="line">kubectl create -f service-account.yml</span><br></pre></td></tr></table></figure></p>
<h3 id="二，创建StatefulSet"><a href="#二，创建StatefulSet" class="headerlink" title="二，创建StatefulSet"></a><strong>二，创建StatefulSet</strong></h3><blockquote>
<p><strong>StatefulSet(有状态副本集)</strong>：Deployments适用于运行无状态应用，StatefulSet则为有状态的应用提供了支持，可以为应用提供有序的部署和扩展，稳定的持久化存储，我们使用SS来运行jenkins master。</p>
</blockquote>
<p>创建完整的Stateful Set需要依次创建一下对象：<br>1、Persistent Volume<br>2、Persistent Volume Claim<br>3、StatefulSet<br>4、Service</p>
<h4 id="创建PersistentVolume："><a href="#创建PersistentVolume：" class="headerlink" title="创建PersistentVolume："></a><strong>创建PersistentVolume：</strong></h4><p>为了保存应用运行时的数据需要先创建k8s的卷文件，K8s中存在Volume和PersistentVolume两种类型：</p>
<blockquote>
<ul>
<li>Volume：与docker中的volume不同在于Volume生命周期是和pod绑定的，与pod中的container无关。k8s为Volume提供了多种类型文件系统（cephfs,nfs…,简单起见我直接选择了hostPath，使用的node节点本地的存储系统）</li>
<li>PersistentVolume:从名字可以看出来，PV的生命周期独立于使用它的pod，不会像volume随pod消失而消失，而是做为一个集群中的资源存在（像node节点一样），同时PV屏蔽了使用具体存储系统的细节。</li>
</ul>
</blockquote>
<p>k8s中的对象都是通过<a href="http://www.ruanyifeng.com/blog/2016/07/yaml.html" target="_blank" rel="noopener">yaml文件</a>来定义的，首先创建名为<code>jenkins-volume.yml</code>的文件:</p>
<p><strong>注意</strong>：PV的创建有静态，动态两种方式，动态创建可以减少管理员的操作步骤，需要提供指定的<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener">StorageClass</a>。为了测试方便，所以我们直接选择静态创建，manual是一个不存在的storage class<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-volume</span><br><span class="line">  labels:</span><br><span class="line">    type: local</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: manual</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &quot;/tmp/data&quot;</span><br></pre></td></tr></table></figure></p>
<p>master节点执行下面的命令，PV就手动创建完了<br><code>kubectl create -f jenkins-volume1.yaml</code></p>
<h4 id="创建PersistentVolumeClaim："><a href="#创建PersistentVolumeClaim：" class="headerlink" title="创建PersistentVolumeClaim："></a><strong>创建PersistentVolumeClaim：</strong></h4><blockquote>
<p>PersistentVolumeClaim(PVC):<br>持久化存储卷索取，如果说PV是集群中的资源，PVC就是资源的消费者，PVC可以指定需要的资源大小和访问方式,pod不会和PV直接接触，而是通过PVC来请求资源，PV的生成阶段叫做provision,生成PV后会绑定到PVC对象，然后才能被其他对象使用。</p>
</blockquote>
<p>PV和PVC的生命周期如下图：<br><img src="/images/jenkins/pvlife.png" alt="pv life"></p>
<p>创建文件<code>jenkins-claim.yaml</code><br><strong>注意：</strong> name必须为jenkins-home-jenkins-0否则会绑定失败<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-home-jenkins-0</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: manual</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Gi</span><br></pre></td></tr></table></figure></p>
<p>执行命令<code>kubectl create -f jenkins-claim.yaml</code><br>然后查看PVC是否创建成功，status为bound说明PVC已经绑定<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl describe pvc jenkins-home-jenkins-0</span><br><span class="line">Name:          jenkins-home-jenkins-0</span><br><span class="line">Namespace:     kubernetes-plugin</span><br><span class="line">StorageClass:  manual</span><br><span class="line">Status:        Bound</span><br><span class="line">Volume:        jenkins-volume</span><br><span class="line">Labels:        &lt;none&gt;</span><br><span class="line">Annotations:   pv.kubernetes.io/bind-completed=yes</span><br><span class="line">               pv.kubernetes.io/bound-by-controller=yes</span><br><span class="line">Capacity:      10Gi</span><br><span class="line">Access Modes:  RWO</span><br><span class="line">Events:        &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="创建StatefulSet和Service："><a href="#创建StatefulSet和Service：" class="headerlink" title="创建StatefulSet和Service："></a><strong>创建StatefulSet和Service：</strong></h4><p>从kubernetes-plugin github仓库下载jenkins.yml文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/jenkinsci/kubernetes-plugin/master/src/main/kubernetes/jenkins.yml</span><br></pre></td></tr></table></figure></p>
<p>修改jenkins.yml：<br>去掉87行<code>externalTrafficPolicy: Local</code>（这是GKE使用的）<br>修改83行<code>type: LoadBalancer</code>改为<code>type: NodePort</code></p>
<p><strong>注意：</strong><br>service type=ClusterIP时只允许从集群内部访问， type设置为NodePort是为了从集群外的机器访问jenkins,请谨慎使用，开启NodePort会在所有节点（含master）的统一固定端口开放服务。</p>
<p>执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl create -f jenkins.yml </span><br><span class="line">statefulset &quot;jenkins&quot; created</span><br><span class="line">service &quot;jenkins&quot; created</span><br></pre></td></tr></table></figure></p>
<p>访问jenkins master,地址为<code>masterip:32058</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查看映射的端口</span><br><span class="line">[root@master ~]# kubectl get service jenkins</span><br><span class="line">NAME      TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)                        AGE</span><br><span class="line">jenkins   NodePort   10.96.82.68   &lt;none&gt;        80:32058/TCP,50000:30345/TCP   1m</span><br></pre></td></tr></table></figure></p>
<p>查看pod : jenkins-0的容器日志，粘贴下面的密码进入jenkins,jenkins安装完成。</p>
<blockquote>
<p>Jenkins initial setup is required. An admin user has been created and a password generated.<br>Please use the following password to proceed to installation:<br>70aa7b41ba894855abccd09306625b8a </p>
</blockquote>
<p>刷新dashboard，切换命名空间到kubernetes-plugin,结果如下：<br><img src="/images/jenkins/success.png" alt="success"></p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>1.创建stateful set时失败，提示”PersistentVolumeClaim is not bound: “jenkins-home-jenkins-0”：”<br>因为采用静态创建PV时，StatefulSet会按照固定名称查找PVC，PVC的名字要满足</p>
<blockquote>
<p>PVC_name == volumeClaimTemplates_name + “-“ + pod_name</p>
</blockquote>
<p>这里的名字就是<code>jenkins-home-jenkins-0</code></p>
<p>2.pod启动失败，jenkins用户没有目录权限<br>错误提示”touch: cannot touch ‘/var/jenkins_home/copy_reference_file.log’: Permission denied<br>Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?”<br>要确保节点目录开放权限,在node上执行命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R 1000:1000 /var/jenkins_home/</span><br><span class="line">sudo chown -R 1000:1000 /tmp/data</span><br><span class="line">##如果仍然失败，尝试在node上重启docker</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></p>
<p>注意pv指定的hostPath权限也要修改，否则是无效的</p>
<h3 id="三-，配置jenkins"><a href="#三-，配置jenkins" class="headerlink" title="三 ，配置jenkins"></a>三 ，配置jenkins</h3><h4 id="创建jenkins服务账号"><a href="#创建jenkins服务账号" class="headerlink" title="创建jenkins服务账号"></a>创建jenkins服务账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/jenkinsci/kubernetes-plugin/master/src/main/kubernetes/service-account.yml</span><br><span class="line">kubectl create -f service-account.yml</span><br></pre></td></tr></table></figure>
<h4 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h4><p>访问<code>http://masterip:32058/pluginManager/</code>,搜索插件Kubernetes plugin安装；<br>访问 <a href="http://masterip:32058/configure" target="_blank" rel="noopener">http://masterip:32058/configure</a><br>选择新建云–kubernetes,在URl填写api server地址，<br>执行kubectl describe命令，复制output中的token，填入到 ‘Kubernetes server certificate key’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get secret </span><br><span class="line">NAME                  TYPE                                  DATA      AGE</span><br><span class="line">default-token-4kb54   kubernetes.io/service-account-token   3         1d</span><br><span class="line">jenkins-token-wzbsx   kubernetes.io/service-account-token   3         1d</span><br><span class="line">[root@master ~]# kubectl describe secret/jenkins-token-wzbsx</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>jenkins url,tunnel填写service的CLUSTER-IP即可，结果如图：<br><img src="/images/jenkins/config1.png" alt="peizhi1"><br>选择add pod template，填写下面的内容，retain slave可以设置运行jenkins slave 的container空闲后能存活多久。<br><img src="/images/jenkins/config.png" alt="content"><br>插件配置完成。</p>
<h3 id="四-，测试"><a href="#四-，测试" class="headerlink" title="四 ，测试"></a>四 ，测试</h3><h4 id="1-扩容测试"><a href="#1-扩容测试" class="headerlink" title="1. 扩容测试"></a>1. 扩容测试</h4><p><strong>StatefulSet扩容：</strong><br>首先需要手动创建PV，PVC(见第二步),然后执行扩容命令<br><code>kubectl scale statefulset/jenkins --replicas=２</code><br>查看StatefulSet,此时已经拥有两个master节点，访问service时会<strong>随机</strong>将请求发送给后端的master。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get statefulset/jenkins </span><br><span class="line">NAME      DESIRED   CURRENT   AGE</span><br><span class="line">jenkins   2         2         5d</span><br></pre></td></tr></table></figure></p>
<p>虽然通过k8s可以轻松实现jenkins master节点的拓展，但是由于jenkins存储数据的方式通过本地文件存储，master之间的数据同步还是一个麻烦的问题，参考<a href="https://yq.aliyun.com/articles/224376" target="_blank" rel="noopener">jenkins存储模型</a>。</p>
<p><em>jenkins master上保存的文件：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ls /temp/data</span><br><span class="line">jenkins.CLI.xml</span><br><span class="line">jenkins.install.InstallUtil.lastExecVersion</span><br><span class="line">jenkins.install.UpgradeWizard.state</span><br><span class="line">jenkins.model.ArtifactManagerConfiguration.xml</span><br><span class="line">jenkins.model.JenkinsLocationConfiguration.xml</span><br><span class="line">jobs</span><br><span class="line">logs</span><br><span class="line">nodeMonitors.xml</span><br><span class="line">nodes</span><br></pre></td></tr></table></figure></p>
<h4 id="2-高可用测试"><a href="#2-高可用测试" class="headerlink" title="2. 高可用测试"></a>2. 高可用测试</h4><p>现在stateful set中已经有两个pod,在jenkins-1所在的节点执行<code>docker stop</code>停止运行jenkins-master的容器，同时在命令行查看pod的状态，可以看到jenkins-1异常（Error状态）之后慢慢恢复了运行状态（Running）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get pods -w</span><br><span class="line">NAME        READY     STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-0   1/1       Running   0          1d</span><br><span class="line">jenkins-1   0/1       Running   1         20h</span><br><span class="line">jenkins-1   1/1       Running   1         20h</span><br><span class="line">jenkins-1   0/1       Error     1         20h</span><br><span class="line">jenkins-1   0/1       CrashLoopBackOff   1         20h</span><br><span class="line">jenkins-1   0/1       Running   2         20h</span><br><span class="line">jenkins-1   1/1       Running   2         20h</span><br></pre></td></tr></table></figure></p>
<p><code>kubectl describe pod jenkins-1</code>查看pod的事件日志，k8s通过探针(probe)接口检测到服务停止之后自动执行了拉取镜像，重启container的操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason      Age                From                              Message</span><br><span class="line">  ----     ------      ----               ----                              -------</span><br><span class="line">  Warning  Unhealthy   27m (x2 over 27m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Readiness probe failed: HTTP probe failed with statuscode: 503</span><br><span class="line">  Warning  Unhealthy   27m (x2 over 27m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Liveness probe failed: HTTP probe failed with statuscode: 503</span><br><span class="line">  Warning  Unhealthy   24m                kubelet, iz8pscwd1fv6kprs1zw21kz  Readiness probe failed: Get http://192.168.24.4:8080/login: dial tcp 192.168.24.4:8080: getsockopt: connection refused</span><br><span class="line">  Warning  BackOff     20m (x2 over 20m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Back-off restarting failed container</span><br><span class="line">  Warning  FailedSync  20m (x2 over 20m)  kubelet, iz8pscwd1fv6kprs1zw21kz  Error syncing pod</span><br><span class="line">  Normal   Pulling     19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  pulling image &quot;jenkins/jenkins:lts-alpine&quot;</span><br><span class="line">  Normal   Started     19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  Started container</span><br><span class="line">  Normal   Pulled      19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  Successfully pulled image &quot;jenkins/jenkins:lts-alpine&quot;</span><br><span class="line">  Normal   Created     19m (x3 over 20h)  kubelet, iz8pscwd1fv6kprs1zw21kz  Created container</span><br></pre></td></tr></table></figure></p>
<h4 id="3-jenkins构建测试"><a href="#3-jenkins构建测试" class="headerlink" title="3. jenkins构建测试"></a>3. jenkins构建测试</h4><p>当前集群中使用的jenkins slave镜像只包含一个java运行环境来运行jenkins-slave.jar,在实际使用中需要自定义合适的镜像。选择自定义镜像之后需要修改插件的配置，同样name命名为jnlp替换默认镜像，arguments安装工具提示填写即可。<br><img src="/images/jenkins/container.png" alt="container"><br>创建job，同时开始构建,k8s会在不同节点上创建pod来运行任务<br><img src="/images/jenkins/pods1.png" alt="此处输入图片的描述"><br>构建全部完成后，资源随即被释放<br><img src="/images/jenkins/result2.png" alt="此处输入图片的描述"></p>
<p><strong>jenkins默认调度策略</strong></p>
<ol>
<li>尝试在上次构建的节点上构建，指定某台slave之后会一直使用。<br>2.当队列有2个构建时，不会立刻创建两个executor,而是先创建一个executor然后尝试等待executor空闲，目的是保证每个executor被充分利用。<br><strong>k8s调度策略</strong></li>
<li>使用Pod.spec.nodeSelector根据label为pod选择node<br>2.调度器scheduler有Predicates，Priorities两个阶段，分别负责节点过滤和评分排序，各个阶段都有k8s提供的检查项，我们可以自由组合。<br>（比如PodFitsResources检查cpu内存等资源，PodFitsHostPorts检查端口占用，SelectorSpreadPriority要求一个服务尽量分散分布）<a href="http://dockone.io/article/2885" target="_blank" rel="noopener">自定义schduler参考</a><br><strong>资源不足时会发生什么</strong><br>当前集群中有3个节点，我在node2运行一个CPU占用限制在80%的程序,然后设置jenkins插件ContainerTemplate的request和limit均为<code>cpu 500m,内存500Mi</code>,（500m代表单核CPU的50%）看一下pod会怎么调度<br>k8s仍然尝试在node2分配节点（为什么其他节点不行），结果POD处于pending状态：<figure class="highlight plain"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;phase&quot;: &quot;Pending&quot;,</span><br><span class="line">&quot;conditions&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;type&quot;: &quot;PodScheduled&quot;,</span><br><span class="line">    &quot;status&quot;: &quot;False&quot;,</span><br><span class="line">    &quot;lastProbeTime&quot;: null,</span><br><span class="line">    &quot;lastTransitionTime&quot;: &quot;2017-12-09T08:29:10Z&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;Unschedulable&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;No nodes are available that match all of the predicates: Insufficient cpu (4), PodToleratesNodeTaints (1).&quot;</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line">&quot;qosClass&quot;: &quot;Guaranteed&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>最后pod被删除，而jenkins任务会阻塞一直到有其他空闲的slave出现。</p>
<h3 id="四-，总结"><a href="#四-，总结" class="headerlink" title="四 ，总结"></a><strong>四 ，总结</strong></h3><p>本文介绍了在k8s集群部署jenkins服务的方式和k8s带来的资源管理便捷，由于我也是刚开始接触k8s,所用的实例只是搭建了用于测试的实验环境，离在实际生产环境中使用还有问题需要验证。</p>

      
    </div>

    
      


    

    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/qrcode.jpg" alt="Xianfeng Song wechat" style="width: 200px; max-width: 100%;">
    <div>关注公众号，第一时间更新</div>
</div>

      </div>
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/jenkins/" rel="tag"># jenkins</a>
          
            <a href="/tags/docker/" rel="tag"># docker</a>
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/26/zookeeper,kafka集群安装/" rel="next" title="zookeeper,kafka集群安装">
                <i class="fa fa-chevron-left"></i> zookeeper,kafka集群安装
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/12/为什么Redis使用ziplist能节省内存/" rel="prev" title="为什么Redis使用ziplist能节省内存？">
                为什么Redis使用ziplist能节省内存？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/logoNew.gif" alt="Xianfeng Song">
            
              <p class="site-author-name" itemprop="name">Xianfeng Song</p>
              <p class="site-description motion-element" itemprop="description">a blog learn share practice</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/xianfengsong" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/xianfengsong" target="_blank" title="Weibo" rel="external nofollow"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一，搭建环境"><span class="nav-number">1.</span> <span class="nav-text">一，搭建环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#工具准备"><span class="nav-number">1.1.</span> <span class="nav-text">工具准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装kubernetes集群"><span class="nav-number">1.2.</span> <span class="nav-text">安装kubernetes集群</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二，创建StatefulSet"><span class="nav-number">2.</span> <span class="nav-text">二，创建StatefulSet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建PersistentVolume："><span class="nav-number">2.1.</span> <span class="nav-text">创建PersistentVolume：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建PersistentVolumeClaim："><span class="nav-number">2.2.</span> <span class="nav-text">创建PersistentVolumeClaim：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建StatefulSet和Service："><span class="nav-number">2.3.</span> <span class="nav-text">创建StatefulSet和Service：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题分析"><span class="nav-number">3.</span> <span class="nav-text">问题分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三-，配置jenkins"><span class="nav-number">4.</span> <span class="nav-text">三 ，配置jenkins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建jenkins服务账号"><span class="nav-number">4.1.</span> <span class="nav-text">创建jenkins服务账号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置插件"><span class="nav-number">4.2.</span> <span class="nav-text">配置插件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四-，测试"><span class="nav-number">5.</span> <span class="nav-text">四 ，测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-扩容测试"><span class="nav-number">5.1.</span> <span class="nav-text">1. 扩容测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-高可用测试"><span class="nav-number">5.2.</span> <span class="nav-text">2. 高可用测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-jenkins构建测试"><span class="nav-number">5.3.</span> <span class="nav-text">3. jenkins构建测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四-，总结"><span class="nav-number">6.</span> <span class="nav-text">四 ，总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xianfeng Song</span>

  

  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Mist</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest-nomobile.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

</body>
</html>

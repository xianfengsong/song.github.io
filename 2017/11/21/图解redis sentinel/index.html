<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="redis sentinel是redis为支持自动failover的主从模式开发的功能，sentinel实际上也是一个redis实例，不过它只支持部分特有命令，通过redis-server /path/to/sentinel.conf --sentinel启动sentinel实例。">
<meta name="keywords" content="redis,nosql,源码">
<meta property="og:type" content="article">
<meta property="og:title" content="图解redis sentinel">
<meta property="og:url" content="http://www.throwsnew.com/2017/11/21/图解redis sentinel/index.html">
<meta property="og:site_name" content="throwsnew">
<meta property="og:description" content="redis sentinel是redis为支持自动failover的主从模式开发的功能，sentinel实际上也是一个redis实例，不过它只支持部分特有命令，通过redis-server /path/to/sentinel.conf --sentinel启动sentinel实例。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.throwsnew.com/images/redis/sentinel.png">
<meta property="og:image" content="http://www.throwsnew.com/images/redis/s1.png">
<meta property="og:image" content="http://www.throwsnew.com/images/redis/s2.png">
<meta property="og:image" content="http://www.throwsnew.com/images/redis/s3.png">
<meta property="og:image" content="http://www.throwsnew.com/images/redis/s4.png">
<meta property="og:image" content="http://www.throwsnew.com/images/redis/s5.png">
<meta property="og:image" content="http://www.throwsnew.com/images/redis/state.png">
<meta property="og:updated_time" content="2019-05-04T16:00:47.392Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="图解redis sentinel">
<meta name="twitter:description" content="redis sentinel是redis为支持自动failover的主从模式开发的功能，sentinel实际上也是一个redis实例，不过它只支持部分特有命令，通过redis-server /path/to/sentinel.conf --sentinel启动sentinel实例。">
<meta name="twitter:image" content="http://www.throwsnew.com/images/redis/sentinel.png">






  <link rel="canonical" href="http://www.throwsnew.com/2017/11/21/图解redis sentinel/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>图解redis sentinel | throwsnew</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1707f79414590fdb8341512803ca4504";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">throwsnew</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>专题</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.throwsnew.com/2017/11/21/图解redis sentinel/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xianfeng Song">
      <meta itemprop="description" content="a blog learn share practice">
      <meta itemprop="image" content="/images/logoNew.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="throwsnew">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">图解redis sentinel
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-21 23:15:46" itemprop="dateCreated datePublished" datetime="2017-11-21T23:15:46+08:00">2017-11-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-05 00:00:47" itemprop="dateModified" datetime="2019-05-05T00:00:47+08:00">2019-05-05</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/redis进阶/" itemprop="url" rel="index"><span itemprop="name">redis进阶</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>redis sentinel是redis为支持自动failover的主从模式开发的功能，sentinel实际上也是一个redis实例，不过它只支持部分特有命令，通过<code>redis-server /path/to/sentinel.conf --sentinel</code>启动sentinel实例。<br><a id="more"></a></p>
<h3 id="整体视图"><a href="#整体视图" class="headerlink" title="整体视图"></a>整体视图</h3><p>sentinel服务由多个节点组成，当进行容灾操作时需要多数节点达成一致，因此sentinel节点之间需要建立通信（蓝色部分）。同时为了监控redis节点状态，每个sentinel节点都会和redis实例建立命令连接（图中虚线），sentinel节点还会通过publish命令向其他节点（包括master/slave/sentinel）发送”hello msg”(参考[^sentinelSendPeriodicCommands]）<br>，通过redis的发布/订阅功能来交换信息。</p>
<p>注意：sentinel接收publish命令时执行的是fake publish<br><img src="/images/redis/sentinel.png" alt="overview"></p>
<p>继续下面的内容前，需要了解sentinel的几个重要配置参数：</p>
<blockquote>
<p><strong>monitor</strong> master_name,master_ip,master_port,quorum<br> (master信息客观下线需要的票数)<br><strong>down-after-milliseconds</strong> master_name XXms (失联多久被视为主观下线)<br><strong>failover-timeout</strong> master_name XXms (处理故障的超时时间)<br><strong>parallel-syncs</strong>  master_name number (执行故障转移时，可以同时从新的master同步数据的slave数量）</p>
</blockquote>
<h3 id="发现新redis实例"><a href="#发现新redis实例" class="headerlink" title="发现新redis实例"></a>发现新redis实例</h3><p>可以发现配置sentinel时不需要填写slave节点的信息，这是因为sentinel可以从它监视的master发送INFO命令获得对应的slave信息，然后再与slave建立连接。通过这种方式sentinel也能够发现新加入的slave节点，过程如图所示：<br><img src="/images/redis/s1.png" alt="1"></p>
<h3 id="发现新sentinel实例"><a href="#发现新sentinel实例" class="headerlink" title="发现新sentinel实例"></a>发现新sentinel实例</h3><p>类似地，一个sentinel实例也能够自主的发现其他sentinel实例，不过这是通过channel接收其他sentinel实例发送的消息实现的，每个sentinel实例会定时所有节点发送PUBLISH命令来向channel投递消息，内容主要是sentinel自己和信息和它保存的master的信息，格式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUBLISH __sentinel__:hello sentinel_ip,sentinel_port,sentinel_runid,current_epoch,</span><br><span class="line">master_name,master_ip,master_port,master_config_epoch.</span><br></pre></td></tr></table></figure></p>
<p>消息会由redis实例的频道发送给所有监视实例的sentinel，其他sentinel收到信息后，如果自己没有保存消息中的sentinel会保存下来，同时epoch如果小于消息中epoch也会自我更新：<br><img src="/images/redis/s2.png" alt="step2"></p>
<h3 id="判断节点下线过程"><a href="#判断节点下线过程" class="headerlink" title="判断节点下线过程"></a>判断节点下线过程</h3><p>sentinel会通过定时向监视的redis实例发送ping命令，检查redis的状态，当redis回复异常或者在超时时间内没有回复时sentinel会将节点设置为主观下线（subjectively down）。而且如果节点是master的话，sentinel需要判断节点是否能设置为客观下线（Objectively down）,过程如图所示：<br>（1）节点回复不正常，sentinel把节点置为主观下线<br>（2）给其他sentinel发送<code>is-master-down-by-addr</code>命令，格式如下<code>IS-MASTER-DOWN-BY-ADDR &lt;master_ip&gt; &lt;master_port&gt; &lt;sentinel:current-epoch&gt; &lt;sentinel:runid&gt;</code><br>（只有当发起投票时才会发送runid,此时runid内容为*）<br>（3）收到<code>is-master-down-by-addr</code>的sentinel检查对应redis实例的状态（实际不会发送ping命令，只是检查保存的节点状态是不是主观下线）<br>（4）发现节点下线回复消息，回复内容如下，后两个是投票时用到的<code>down state, leader, vote epoch</code><br>（5）当sentinel1 收到足够多的“节点下线”的回复后（大于配置的quorum），将master状态设置为客观下线，然后failover流程才开始进行。</p>
<p><img src="/images/redis/s3.png" alt="s3"></p>
<h3 id="failover第一步-选举leader"><a href="#failover第一步-选举leader" class="headerlink" title="failover第一步:选举leader"></a>failover第一步:选举leader</h3><p>failover操作只能由一个sentinel节点来执行，因此开始failover首先要选举出一个Leader,sentinel的选举采用的是<a href="http://www.infoq.com/cn/articles/raft-paper" target="_blank" rel="noopener">Raft算法</a>中的领导人选举机制。在这里确认master客观下线的sentinel会成为候选人，等待failover_start_time（一个随机时间，为了避免候选人同时开始选举导致平票），然后开始向其他实例发起投票请求，依然是使用<code>is-master-down-by-addr</code>命令，投票时主要依据是epoch字段。具体流程如图所示：<br><img src="/images/redis/s4.png" alt="s4"></p>
<h3 id="failover第二步：执行故障转移"><a href="#failover第二步：执行故障转移" class="headerlink" title="failover第二步：执行故障转移"></a>failover第二步：执行故障转移</h3><p>Leader选举成功之后，会在slave中选择一个最优的，然后“提拔”这个slave作为新的master,然后其他redis实例会来同步新master的数据，具体过程如下：<br><img src="/images/redis/s5.png" alt="dofailover"></p>
<h3 id="sentinel的整体执行流程"><a href="#sentinel的整体执行流程" class="headerlink" title="sentinel的整体执行流程"></a>sentinel的整体执行流程</h3><p>上面描述的行为都是通过redis定时任务来驱动的，特别的，sentinel中定义了一个状态机（switch-case代码块）来根据此时master的failover_state执行不同的操作，下面的图从外向内展示了sentinel主要功能的调用过程：</p>
<blockquote>
<p>（1）servCron函数(在server.c)负责执行redis的定时任务，包括过期键，写AOF文件等等，同时包括执行sentinel定时任务<br>（2）sentinelTimer(sentinel.c)是sentinel模式的定时任务，执行<a href="http://doc.redisfans.com/topic/sentinel.html#tilt" target="_blank" rel="noopener">TILT模式</a>的检查，执行脚本，还有就是处理RedisInstance（集群中所有的master/slave/sentinel实例）<br>（3）在sentinelHandleRedisInstance函数中，会依次执行reconnect函数维护与其他实例的连接（命令连接和pub/sub）,定期发送命令（info/ping/hello）,判断主观下线<br>（4）当实例是master时会执行客观下线的检查，在StartFailoverIfNeeded函数中，如果满足条件会开始failover的过程（master会变成SENTINEL_FAILOVER_STATE_WAIT_START，然后还会向其他sentinel确认master状态，使用force模式才会发送is-master-down命令，此时可能也会发起投票）<br>（5）状态机逻辑的执行在StartFailoverIfNeeded执行之后（和上一步结果无关），状态机就是在每次定时任务循环中检查当前master的状态然后执行不同阶段的failover操作，最后会执行askOther的步骤，本次定时任务结束。</p>
</blockquote>
<p><img src="/images/redis/state.png" alt="state"></p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p><strong>1、完整的failoverstate</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Failover machine different states. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_NONE 0  <span class="comment">/* No failover in progress. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_WAIT_START 1  <span class="comment">/* Wait for failover_start_time*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_SELECT_SLAVE 2 <span class="comment">/* Select slave to promote */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE 3 <span class="comment">/* Slave -&gt; Master */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_WAIT_PROMOTION 4 <span class="comment">/* Wait slave to change role */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_RECONF_SLAVES 5 <span class="comment">/* SLAVEOF newmaster */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_UPDATE_CONFIG 6 <span class="comment">/* Monitor promoted slave.master配置更新为新的master */</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>2、redis实例收到的sentinel消息</strong><br>集群中一台slave的hello频道中传播的消息，此时master端口是6380：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; psubscribe *</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;__sentinel__:hello&quot;</span><br><span class="line">4) &quot;127.0.0.1,26380,299da3eb5862baf267d16e36306defe7517bab5b,3,mymaster,127.0.0.1,6380,3&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;__sentinel__:hello&quot;</span><br><span class="line">4) &quot;127.0.0.1,26381,bf3ac725160092d5db0fefdcc4814379003a75a8,3,mymaster,127.0.0.1,6380,3&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;__sentinel__:hello&quot;</span><br><span class="line">4) &quot;127.0.0.1,26379,9e47039b5fd9735296df2340e54a4c37caeabbb2,3,mymaster,127.0.0.1,6380,3&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>3、一次failover的日志</strong><br>master port:6380<br>Leader port:26380<br>Leader run_id:299da3eb5862baf267d16e36306defe7517bab5b<br><strong>follower sentinel收到的消息:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:26379&gt; psubscribe *</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;psubscribe&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+new-epoch&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+vote-for-leader&quot;</span><br><span class="line">4) &quot;299da3eb5862baf267d16e36306defe7517bab5b 2&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+sdown&quot;</span><br><span class="line">4) &quot;master mymaster 127.0.0.1 6380&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+odown&quot;</span><br><span class="line">4) &quot;master mymaster 127.0.0.1 6380 #quorum 3/2&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+config-update-from&quot;</span><br><span class="line">4) &quot;sentinel 127.0.0.1:26380 127.0.0.1 26380 @ mymaster 127.0.0.1 6380&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+switch-master&quot;</span><br><span class="line">4) &quot;mymaster 127.0.0.1 6380 127.0.0.1 6381&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+slave&quot;</span><br><span class="line">4) &quot;slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+slave&quot;</span><br><span class="line">4) &quot;slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+sdown&quot;</span><br><span class="line">4) &quot;slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;-role-change&quot;</span><br><span class="line">4) &quot;slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381 new reported role is master&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;-sdown&quot;</span><br><span class="line">4) &quot;slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;*&quot;</span><br><span class="line">3) &quot;+role-change&quot;</span><br><span class="line">4) &quot;slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381 new reported role is slave&quot;</span><br></pre></td></tr></table></figure></p>
<p>sentinel消息各种 + - 标识的含义:</p>
<blockquote>
<p>+reset-master <instance details=""> – The master was reset.<br>    +slave <instance details=""> – A new slave was detected and attached.<br>    +failover-state-reconf-slaves <instance details=""> – Failover state changed to reconf-slaves state.<br>    +failover-detected <instance details=""> – A failover started by another Sentinel or any other external entity was detected (An attached slave turned into a master).<br>    +slave-reconf-sent <instance details=""> – The leader sentinel sent the SLAVEOF command to this instance in order to reconfigure it for the new slave.<br>    +slave-reconf-inprog <instance details=""> – The slave being reconfigured showed to be a slave of the new master ip:port pair, but the synchronization process is not yet complete.<br>    +slave-reconf-done <instance details=""> – The slave is now synchronized with the new master.<br>    -dup-sentinel <instance details=""> – One or more sentinels for the specified master were removed as duplicated (this happens for instance when a Sentinel instance is restarted).<br>    +sentinel <instance details=""> – A new sentinel for this master was detected and attached.<br>    +sdown <instance details=""> – The specified instance is now in Subjectively Down state.<br>    -sdown <instance details=""> – The specified instance is no longer in Subjectively Down state.<br>    +odown <instance details=""> – The specified instance is now in Objectively Down state.<br>    -odown <instance details=""> – The specified instance is no longer in Objectively Down state.<br>    +new-epoch <instance details=""> – The current epoch was updated.<br>    +try-failover <instance details=""> – New failover in progress, waiting to be elected by the majority.<br>    +elected-leader <instance details=""> – Won the election for the specified epoch, can do the failover.<br>    +failover-state-select-slave <instance details=""> – New failover state is select-slave: we are trying to find a suitable slave for promotion.<br>    no-good-slave <instance details=""> – There is no good slave to promote. Currently we’ll try after some time, but probably this will change and the state machine will abort the failover at all in this case.<br>    selected-slave <instance details=""> – We found the specified good slave to promote.<br>    failover-state-send-slaveof-noone <instance details=""> – We are trying to reconfigure the promoted slave as master, waiting for it to switch.<br>    failover-end-for-timeout <instance details=""> – The failover terminated for timeout, slaves will eventually be configured to replicate with the new master anyway.<br>    failover-end <instance details=""> – The failover terminated with success. All the slaves appears to be reconfigured to replicate with the new master.<br>    switch-master <master name=""> <oldip> <oldport> <newip> <newport> – The master new IP and address is the specified one after a configuration change. This is the message most external users are interested in.<br>    +tilt – Tilt mode entered.<br>    -tilt – Tilt mode exited.</newport></newip></oldport></oldip></master></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></instance></p>
</blockquote>
<p><strong>leader 日志</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[30369] 13 Jan 20:21:06.701 # +sdown master mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:06.768 # +odown master mymaster 127.0.0.1 6380 #quorum 2/2</span><br><span class="line">[30369] 13 Jan 20:21:06.768 # +new-epoch 2</span><br><span class="line">[30369] 13 Jan 20:21:06.768 # +try-failover master mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:06.782 # +vote-for-leader 299da3eb5862baf267d16e36306defe7517bab5b 2</span><br><span class="line">[30369] 13 Jan 20:21:06.821 # 127.0.0.1:26381 voted for 299da3eb5862baf267d16e36306defe7517bab5b 2</span><br><span class="line">[30369] 13 Jan 20:21:06.821 # 127.0.0.1:26379 voted for 299da3eb5862baf267d16e36306defe7517bab5b 2</span><br><span class="line">[30369] 13 Jan 20:21:06.844 # +elected-leader master mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:06.844 # +failover-state-select-slave master mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:06.902 # +selected-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:06.902 * +failover-state-send-slaveof-noone slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:06.965 * +failover-state-wait-promotion slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:07.830 # +promoted-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:07.830 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:07.872 * +slave-reconf-sent slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:08.852 * +slave-reconf-inprog slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:21:08.976 # -odown master mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:22:53.198 * +reboot master mymaster 127.0.0.1 6380</span><br><span class="line">[30369] 13 Jan 20:22:53.249 # -sdown master mymaster 127.0.0.1 6380</span><br></pre></td></tr></table></figure></p>
<p><strong>follower 日志</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[29838] 13 Jan 20:21:06.803 # +new-epoch 2</span><br><span class="line">[29838] 13 Jan 20:21:06.821 # +vote-for-leader 299da3eb5862baf267d16e36306defe7517bab5b 2</span><br><span class="line">[29838] 13 Jan 20:21:06.821 # +sdown master mymaster 127.0.0.1 6380</span><br><span class="line">[29838] 13 Jan 20:21:06.898 # +odown master mymaster 127.0.0.1 6380 #quorum 3/2</span><br><span class="line">[29838] 13 Jan 20:21:06.898 # Next failover delay: I will not start a failover before Sat Jan 13 20:27:07 2018</span><br><span class="line">[29838] 13 Jan 20:21:07.874 # +config-update-from sentinel 127.0.0.1:26380 127.0.0.1 26380 @ mymaster 127.0.0.1 6380</span><br><span class="line">[29838] 13 Jan 20:21:07.874 # +switch-master mymaster 127.0.0.1 6380 127.0.0.1 6381</span><br><span class="line">[29838] 13 Jan 20:21:07.874 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381</span><br><span class="line">[29838] 13 Jan 20:21:07.894 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381</span><br><span class="line">[29838] 13 Jan 20:21:37.913 # +sdown slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381</span><br><span class="line">[29838] 13 Jan 20:22:53.322 # -sdown slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381</span><br></pre></td></tr></table></figure></p>
<p>[^sentinelSendPeriodicCommands]:<a href="https://github.com/antirez/redis/blob/3.0/src/sentinel.c" target="_blank" rel="noopener">https://github.com/antirez/redis/blob/3.0/src/sentinel.c</a> sentinelSendPeriodicCommands()</p>

      
    </div>

    
      


    

    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/qrcode.jpg" alt="Xianfeng Song wechat" style="width: 200px; max-width: 100%;">
    <div>关注公众号，第一时间更新</div>
</div>

      </div>
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag"># redis</a>
          
            <a href="/tags/nosql/" rel="tag"># nosql</a>
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/22/图解redis主从/" rel="next" title="图解redis主从">
                <i class="fa fa-chevron-left"></i> 图解redis主从
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/26/Mesos安装/" rel="prev" title="Mesos安装">
                Mesos安装 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/logoNew.gif" alt="Xianfeng Song">
            
              <p class="site-author-name" itemprop="name">Xianfeng Song</p>
              <p class="site-description motion-element" itemprop="description">a blog learn share practice</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/xianfengsong" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/xianfengsong" target="_blank" title="Weibo" rel="external nofollow"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#整体视图"><span class="nav-number">1.</span> <span class="nav-text">整体视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发现新redis实例"><span class="nav-number">2.</span> <span class="nav-text">发现新redis实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发现新sentinel实例"><span class="nav-number">3.</span> <span class="nav-text">发现新sentinel实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#判断节点下线过程"><span class="nav-number">4.</span> <span class="nav-text">判断节点下线过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#failover第一步-选举leader"><span class="nav-number">5.</span> <span class="nav-text">failover第一步:选举leader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#failover第二步：执行故障转移"><span class="nav-number">6.</span> <span class="nav-text">failover第二步：执行故障转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sentinel的整体执行流程"><span class="nav-number">7.</span> <span class="nav-text">sentinel的整体执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#附录"><span class="nav-number">8.</span> <span class="nav-text">附录</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright"> &copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xianfeng Song</span>

  

  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Mist</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest-nomobile.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
